# Promtail 설정 - Grafana Cloud 연동
# 환경 변수: LOKI_URL, LOKI_USER, LOKI_API_KEY

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

# Grafana Cloud Loki 클라이언트
clients:
  - url: ${LOKI_URL}
    basic_auth:
      username: ${LOKI_USER}
      password: ${LOKI_API_KEY}
    # 배치 설정 (성능 최적화)
    batchwait: 1s
    batchsize: 1048576 # 1MB
    timeout: 10s

scrape_configs:
  # Docker 컨테이너 로그 (stdout/stderr) - JSON 형식
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ['blog-nextjs', 'blog-nginx']

    relabel_configs:
      # 컨테이너 이름을 레이블로
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: container
      # 로그 스트림 (stdout/stderr)
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: stream

    pipeline_stages:
      # 1단계: Docker CRI 형식 파싱 (Docker json-file driver)
      - cri: {}

      # 2단계: 애플리케이션 JSON 로그 파싱
      - json:
          expressions:
            timestamp: timestamp
            level: level
            source: source
            message: message
            method: method
            path: path
            url: url
            status: status
            ip: ip
            request_time: request_time
            duration_ms: duration_ms
            trace_id: trace_id
            user_agent: user_agent
            referer: referer
            host: host
            request_id: request_id
            meta: meta

      # 3단계: 레이블 추가 (카디널리티 낮은 필드만)
      - labels:
          level:
          source:
          method:
          container:
          stream:

      # 4단계: 타임스탬프 파싱
      - timestamp:
          source: timestamp
          format: RFC3339Nano
          fallback_formats:
            - RFC3339
            - '2006-01-02T15:04:05.000Z07:00'
            - '2006-01-02T15:04:05Z07:00'

      # 5단계: 출력 포맷 (message 필드 사용)
      - output:
          source: message

  # 선택사항: healthcheck 로그 제외하여 볼륨 절약
  - job_name: docker_filtered
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    pipeline_stages:
      - drop:
          expression: '.*healthcheck.*'
      - drop:
          expression: '.*favicon.ico.*'
