name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Login to Amazon ECR (ì„ íƒì‚¬í•­)
        if: false  # ECR ì‚¬ìš© ì‹œ trueë¡œ ë³€ê²½
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          APP_DIR: /home/ubuntu/blog
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          envs: APP_DIR
          script: |
            set -e
            
            echo "ğŸš€ Starting deployment..."
            
            # ì• í”Œë¦¬ì¼€ì´ì…˜ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd $APP_DIR
            
            # Git pull (ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°)
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main
            
            # Docker Composeë¡œ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ë° ì¬ì‹œì‘
            echo "ğŸ³ Building and restarting containers..."
            docker-compose down
            docker-compose build --no-cache
            docker-compose up -d
            
            # ì´ì „ ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=24h"
            
            # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
            echo "âœ… Checking container status..."
            docker-compose ps
            
            # ë¡œê·¸ í™•ì¸
            echo "ğŸ“‹ Recent logs:"
            docker-compose logs --tail=50
            
            echo "âœ¨ Deployment completed successfully!"

      - name: Health check
        run: |
          echo "ğŸ¥ Performing health check..."
          sleep 30
          response=$(curl -s -o /dev/null -w "%{http_code}" https://byeoung.dev/health || echo "000")
          if [ "$response" = "200" ]; then
            echo "âœ… Health check passed!"
          else
            echo "âŒ Health check failed with status code: $response"
            exit 1
          fi

      - name: Notify deployment status
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Deployment to EC2: ${{ job.status }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
