# 통합 JSON 로그 포맷 (Middleware/Application과 동일한 스키마)
log_format json_unified escape=json
    '{'
        '"timestamp":"$time_iso8601",'
        '"level":"info",'
        '"source":"nginx",'
        '"message":"HTTP Request",'
        '"method":"$request_method",'
        '"path":"$request_uri",'
        '"url":"$scheme://$host$request_uri",'
        '"status":$status,'
        '"ip":"$remote_addr",'
        '"user_agent":"$http_user_agent",'
        '"referer":"$http_referer",'
        '"request_time":$request_time,'
        '"duration_ms":$request_time,'
        '"upstream_addr":"$upstream_addr",'
        '"upstream_status":"$upstream_status",'
        '"upstream_response_time":"$upstream_response_time",'
        '"upstream_connect_time":"$upstream_connect_time",'
        '"upstream_header_time":"$upstream_header_time",'
        '"host":"$host",'
        '"protocol":"$server_protocol",'
        '"request_id":"$request_id",'
        '"trace_id":"$request_id",'
        '"ssl_protocol":"$ssl_protocol",'
        '"ssl_cipher":"$ssl_cipher",'
        '"http_x_forwarded_for":"$http_x_forwarded_for",'
        '"body_bytes_sent":$body_bytes_sent,'
        '"is_prefetch":"$http_sec_purpose$http_purpose"'
    '}';

# 봇 User-Agent 감지 (로깅 제외용)
map $http_user_agent $is_bot {
    default 0;
    ~*bot 1;
    ~*crawl 1;
    ~*spider 1;
    ~*slurp 1;
    ~*googlebot 1;
    ~*bingbot 1;
    ~*yandex 1;
    ~*baidu 1;
    ~*duckduckbot 1;
    ~*facebookexternalhit 1;
    ~*twitterbot 1;
    ~*linkedinbot 1;
    ~*whatsapp 1;
    ~*telegram 1;
    ~*discordbot 1;
    ~*pingdom 1;
    ~*uptimerobot 1;
    ~*monitoring 1;
    ~*healthcheck 1;
    ~*curl 1;
    ~*wget 1;
    ~*python-requests 1;
    ~*java 1;
    ~*apache-httpclient 1;
    ~*go-http-client 1;
}

# 로깅 여부 결정 (봇이거나 헬스체크면 로깅 제외)
map $is_bot$is_healthcheck $loggable {
    default 1;
    ~*1 0;
}

# Upstream 서버 정의 (Next.js)
upstream nextjs_upstream {
    server nextjs:3000;
    keepalive 32;
}

# HTTP -> HTTPS 리다이렉트
server {
    listen 80;
    listen [::]:80;
    server_name byeoung.dev www.byeoung.dev resume.byeoung.dev;

    # Let's Encrypt 인증서 갱신을 위한 경로
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 나머지 모든 요청은 HTTPS로 리다이렉트
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS 서버 설정
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name byeoung.dev www.byeoung.dev resume.byeoung.dev;

    # SSL 인증서 경로 (Let's Encrypt)
    ssl_certificate /etc/nginx/ssl/fullchain.pem;
    ssl_certificate_key /etc/nginx/ssl/privkey.pem;

    # SSL 보안 설정
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 보안 헤더
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 클라이언트 최대 업로드 크기
    client_max_body_size 10M;

    # 로그 설정 (통합 JSON 포맷 사용, 봇/헬스체크 제외)
    access_log /var/log/nginx/access.log json_unified if=$loggable;
    error_log /var/log/nginx/error.log warn;

    # Next.js로 프록시
    location / {
        proxy_pass http://nextjs_upstream;
        proxy_http_version 1.1;

        # WebSocket 지원
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # 프록시 헤더
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;

        # TraceId 전달 (Nginx에서 생성한 request_id를 Middleware/Application으로 전달)
        proxy_set_header X-Request-ID $request_id;
        proxy_set_header X-Trace-ID $request_id;

        # 타임아웃 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 버퍼 설정
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # 정적 파일 캐싱 최적화 (_next/static)
    location /_next/static/ {
        proxy_pass http://nextjs_upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # 정적 파일 캐싱 (1년)
        expires 365d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # 이미지 및 미디어 파일 캐싱
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
        proxy_pass http://nextjs_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;

        expires 30d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # favicon
    location = /favicon.ico {
        proxy_pass http://nextjs_upstream;
        log_not_found off;
        access_log off;
    }

    # robots.txt
    location = /robots.txt {
        proxy_pass http://nextjs_upstream;
        log_not_found off;
        access_log off;
    }
}
